# LogicTest: 3node-tenant-multiregion
# tenant-cluster-setting-override-opt: allow-zone-configs-for-secondary-tenants allow-multi-region-abstractions-for-secondary-tenants

# Create a table on the secondary tenant.
statement ok
CREATE TABLE t (k INT PRIMARY KEY, v INT)

# Split the ranges in the table.
statement ok
ALTER TABLE t SPLIT AT VALUES (1), (2), (3)

# Relocate ranges in the admin tenant based on node locality.
user host-cluster-root

statement ok
ALTER RANGE RELOCATE LEASE TO 1 FOR SELECT range_id FROM crdb_internal.ranges WHERE start_pretty LIKE '%Tenant%1'

statement ok
ALTER RANGE RELOCATE LEASE TO 2 FOR SELECT range_id FROM crdb_internal.ranges WHERE start_pretty LIKE '%Tenant%2'

statement ok
ALTER RANGE RELOCATE LEASE TO 3 FOR SELECT range_id FROM crdb_internal.ranges WHERE start_pretty LIKE '%Tenant%3'

# Check range lease holders in the admin tenant.
query TI
SELECT start_pretty, lease_holder FROM crdb_internal.ranges WHERE start_pretty LIKE '%Tenant%'
----
/Tenant/10                1
/Tenant/10/Table/106/1/1  1
/Tenant/10/Table/106/1/2  2
/Tenant/10/Table/106/1/3  3

# TODO(harding): Once locality-aware distribution is implemented, run queries in
# the secondary tenant.
user root

# Check sql instance locality in the secondary tenant.
query IT
SELECT id, locality FROM system.sql_instances
----
1  {"Tiers": "region=test"}
2  {"Tiers": "region=test1"}
3  {"Tiers": "region=test2"}

# This is a single span, so without the spanIter this will be a local query.
# ALTER TABLE t SPLIT AT VALUES (1), (2), (3)
query T
EXPLAIN (DISTSQL) SELECT * FROM t WHERE k=1 OR k=2 OR k=3
----
distribution: local
vectorized: true
·
• scan
  missing stats
  table: t@t_pkey
  spans: [/1 - /3]
·
Diagram: https://cockroachdb.github.io/distsqlplan/decode.html#eJyMT19L-zAUff99ist5Wn9E2qj4EBCUWbEwt9kOFKRIbS5jrGtqkooy-t1lqTB8EHw7f5Jzzt3DvTVQSJ-Ws-tsTpObrFgVD7OIinSWTlf0n27zxT15erxL85Qmky1dkoxokVOAp9ERn0UQaI3mebVjB_UMiVKgs6Zm54w9SPvwINMfUInApu16f5BLgdpYhtrDb3zDUFhVrw3nXGm2cQIBzb7aNCHWX_mXbsufEJiapt-1TtFW0DsEiq46sFgmF7GM5ck3OEc5CJjeH_ucr9YMJQfx9005u860jn_M-S05GUoB1mse73amtzUvralDzUgX4V8QNDs_unIkWTtaQzn8-woAAP__PcKCKw==
